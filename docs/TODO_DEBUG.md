# ðŸ” 02-interrupts.gb ã‚¿ã‚¤ãƒžãƒ¼å•é¡Œ å®Œå…¨èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´10æœˆ28æ—¥
**ç¾åœ¨ã®çŠ¶æ…‹**: Blarggãƒ†ã‚¹ãƒˆ 10/11é€šéŽ (90.9%)
**æœªè§£æ±º**: 02-interrupts.gbï¼ˆTest #4 "Timer doesn't work"ï¼‰

---

## ðŸ“‹ ç›®æ¬¡

1. [ç¾çŠ¶ã‚µãƒžãƒªãƒ¼](#ç¾çŠ¶ã‚µãƒžãƒªãƒ¼)
2. [å®Ÿæ–½ã—ãŸä¿®æ­£](#å®Ÿæ–½ã—ãŸä¿®æ­£)
3. [è©³ç´°èª¿æŸ»çµæžœ](#è©³ç´°èª¿æŸ»çµæžœ)
4. [æ ¹æœ¬åŽŸå› ã®ç‰¹å®š](#æ ¹æœ¬åŽŸå› ã®ç‰¹å®š)
5. [çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…è¨ˆç”»](#çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…è¨ˆç”»)
6. [æŠ€è¡“çš„è©³ç´°](#æŠ€è¡“çš„è©³ç´°)
7. [å‚è€ƒè³‡æ–™](#å‚è€ƒè³‡æ–™)

---

## ç¾çŠ¶ã‚µãƒžãƒªãƒ¼

### âœ… æˆåŠŸã—ã¦ã„ã‚‹é …ç›®

- **Blarggãƒ†ã‚¹ãƒˆ**: 10/11é€šéŽ (90.9%)
- **ã‚¿ã‚¤ãƒžãƒ¼åŸºæœ¬å‹•ä½œ**: æ­£å¸¸ï¼ˆ16ã‚µã‚¤ã‚¯ãƒ«/ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ @TAC=0x05ï¼‰
- **ã‚¿ã‚¤ãƒžãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼**: æ­£å¸¸ï¼ˆ4096ã‚µã‚¤ã‚¯ãƒ«ã§ç™ºç”Ÿï¼‰
- **EIå‘½ä»¤**: æ­£å¸¸å®Ÿè£…ï¼ˆei_delay=2ã§1å‘½ä»¤å¾Œã«æœ‰åŠ¹åŒ–ï¼‰
- **HALTãƒã‚°**: å®Œå…¨å®Ÿè£…æ¸ˆã¿
- **å‰²ã‚Šè¾¼ã¿å‡¦ç†**: æ­£å¸¸å‹•ä½œ

### âŒ å¤±æ•—ã—ã¦ã„ã‚‹é …ç›®

- **02-interrupts.gb**: Test #4 "Timer doesn't work"ã§å¤±æ•—
- **æœŸå¾…ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: 1500ã‚µã‚¤ã‚¯ãƒ«ã§å‰²ã‚Šè¾¼ã¿
- **å®Ÿéš›ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: 4096ã‚µã‚¤ã‚¯ãƒ«ã§å‰²ã‚Šè¾¼ã¿ï¼ˆç†è«–å€¤é€šã‚Šï¼‰
- **å·®åˆ†**: ç´„2.7å€ã®ä¹–é›¢

---

## å®Ÿæ–½ã—ãŸä¿®æ­£

### ä¿®æ­£1: timer.tick()ã¸ã®å¼•æ•°å¤‰æ›´ï¼ˆ2025å¹´10æœˆ28æ—¥ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/gameboy/emulator.py:207`

```python
# ä¿®æ­£å‰ï¼ˆâŒ èª¤ã‚Šï¼‰
timer_interrupt_occurred = self.timer.tick(cpu_cycles)  # ç›¸å¯¾ã‚µã‚¤ã‚¯ãƒ«

# ä¿®æ­£å¾Œï¼ˆâœ… æ­£ã—ã„ï¼‰
timer_interrupt_occurred = self.timer.tick(self.cpu.cycles)  # ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«
```

**ç†ç”±**:
- timer.pyå†…éƒ¨ã§`cycles = _cycles - self.last_cycles`ã¨ã—ã¦å·®åˆ†è¨ˆç®—ã—ã¦ã„ã‚‹
- ç›¸å¯¾ã‚µã‚¤ã‚¯ãƒ«ã‚’æ¸¡ã™ã¨ã€2å›žç›®ä»¥é™`delta=0`ã«ãªã‚Šæ›´æ–°ã•ã‚Œãªã„å•é¡ŒãŒã‚ã£ãŸ
- PyBoyå®Ÿè£…ã¨åŒæ§˜ã«ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹

**çµæžœ**:
- ã‚¿ã‚¤ãƒžãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã£ãŸ
- ã—ã‹ã—ã€02-interrupts.gbã¯ä¾ç„¶ã¨ã—ã¦å¤±æ•—

---

## è©³ç´°èª¿æŸ»çµæžœ

### èª¿æŸ»1: ã‚¿ã‚¤ãƒžãƒ¼å‹•ä½œã®ç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `test_timer_02.py`

```
TAC=0x05è¨­å®šå¾Œã®å‹•ä½œ:
- Cycle +8:   TIMA 0x00 -> 0x01  (8ã‚µã‚¤ã‚¯ãƒ«)
- Cycle +40:  TIMA 0x01 -> 0x02  (32ã‚µã‚¤ã‚¯ãƒ«)
- Cycle +56:  TIMA 0x02 -> 0x03  (16ã‚µã‚¤ã‚¯ãƒ«)
- Cycle +88:  TIMA 0x03 -> 0x05  (32ã‚µã‚¤ã‚¯ãƒ«ã€2å¢—åŠ )
...
```

**è¦³å¯Ÿäº‹é …**:
- åŸºæœ¬çš„ã«16ã‚µã‚¤ã‚¯ãƒ«ã”ã¨ã«TIMAã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆç†è«–å€¤é€šã‚Šï¼‰
- æ™‚ã€…32ã‚µã‚¤ã‚¯ãƒ«ã‹ã‹ã‚‹ï¼ˆCPUã®å‘½ä»¤å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã‚‹ï¼‰
- TIMAãŒ2å¢—ãˆã‚‹ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ï¼ˆwhileãƒ«ãƒ¼ãƒ—å†…ã§è¤‡æ•°å›žã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼‰

### èª¿æŸ»2: timer.tick()ã®äºŒé‡å‘¼ã³å‡ºã—

**ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `test_timer_double_call.py`

```
Step 0: cpu.cycles before=568124
  tick#1: cycles=568132, last_cycles=568132, delta=0, result=False
Step 1: cpu.cycles before=568132
  [Memory WRITE] Calling timer.tick(568132) for address 0xFF05, value=0x00
  tick#2: cycles=568132, last_cycles=568132, delta=0, result=False
  tick#3: cycles=568144, last_cycles=568144, delta=0, result=False
```

**è¦³å¯Ÿäº‹é …**:
- 1å›žã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¤‡æ•°å›žtimer.tick()ãŒå‘¼ã°ã‚Œã‚‹
  1. emulator.step()ã‹ã‚‰: ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«ã§å‘¼ã³å‡ºã—
  2. memory.pyï¼ˆã‚¿ã‚¤ãƒžãƒ¼ãƒ¬ã‚¸ã‚¹ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼‰: ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«ã§å‘¼ã³å‡ºã—
- timer.pyå†…éƒ¨ã®`if cycles == 0: return False`ã§2å›žç›®ä»¥é™ã¯ç„¡è¦–ã•ã‚Œã‚‹
- ã“ã®è¨­è¨ˆã¯æ©Ÿèƒ½çš„ã«ã¯å•é¡Œãªã„ãŒã€è¤‡é›‘

### èª¿æŸ»3: Blarggãƒ†ã‚¹ãƒˆã®æœŸå¾…å‹•ä½œ

**ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰åˆ†æž**ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°çµæžœèª¿æŸ»å†…å®¹.md ã‚ˆã‚Šï¼‰:

```assembly
set_test 4,"Timer doesn't work"
wreg TAC,$05
wreg TIMA,0
wreg IF,0
delay 500        ; 500ã‚µã‚¤ã‚¯ãƒ«å¾…æ©Ÿ
lda  IF
delay 500        ; ã•ã‚‰ã«500ã‚µã‚¤ã‚¯ãƒ«å¾…æ©Ÿ
and  $04
jp   nz,test_failed  ; 1000ã‚µã‚¤ã‚¯ãƒ«å¾Œã«å‰²ã‚Šè¾¼ã¿ãŒã‚ã£ã¦ã¯ãƒ€ãƒ¡
delay 500        ; ã•ã‚‰ã«500ã‚µã‚¤ã‚¯ãƒ«å¾…æ©Ÿ
lda  IF
and  $04
jp   z,test_failed   ; 1500ã‚µã‚¤ã‚¯ãƒ«å¾Œã«ã¯å‰²ã‚Šè¾¼ã¿ãŒã‚ã‚‹ã¹ã
```

**æ•°å­¦çš„è§£æž**:

```
TAC=0x05 (262144Hz) = 16ã‚µã‚¤ã‚¯ãƒ«/TIMAã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
TIMA=0â†’256ã§4096ã‚µã‚¤ã‚¯ãƒ«ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ï¼ˆç†è«–å€¤ï¼‰

Blarggãƒ†ã‚¹ãƒˆã®æœŸå¾…:
- 1000ã‚µã‚¤ã‚¯ãƒ«å¾Œ: IF&0x04 = 0 (å‰²ã‚Šè¾¼ã¿ãªã—) âœ…
- 1500ã‚µã‚¤ã‚¯ãƒ«å¾Œ: IF&0x04 â‰  0 (å‰²ã‚Šè¾¼ã¿ã‚ã‚Š) âŒ

å®Ÿéš›ã®å‹•ä½œ:
- 1000ã‚µã‚¤ã‚¯ãƒ«å¾Œ: TIMA = 62 (å‰²ã‚Šè¾¼ã¿ãªã—) âœ…
- 1500ã‚µã‚¤ã‚¯ãƒ«å¾Œ: TIMA = 93 (å‰²ã‚Šè¾¼ã¿ãªã—) âŒ
- 4096ã‚µã‚¤ã‚¯ãƒ«å¾Œ: TIMA overflow (å‰²ã‚Šè¾¼ã¿ç™ºç”Ÿ)
```

**é€†ç®—**:

```
1500ã‚µã‚¤ã‚¯ãƒ« Ã· 16 = 93.75å›žã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

BlarggãŒæœŸå¾…ã™ã‚‹TIMAåˆæœŸå€¤ï¼ˆæŽ¨æ¸¬ï¼‰:
256 - 93 = 163 (0xA3)

ã“ã®å ´åˆ:
- 1000ã‚µã‚¤ã‚¯ãƒ«å¾Œ: TIMA = 163 + 62 = 225 (ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã—ãªã„)
- 1500ã‚µã‚¤ã‚¯ãƒ«å¾Œ: TIMA = 163 + 93 = 256 (ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼)
```

**çµè«–**: Blarggãƒ†ã‚¹ãƒˆã¯ã€TIMA=0ã‹ã‚‰é–‹å§‹ã—ã¦ã‚‚1500ã‚µã‚¤ã‚¯ãƒ«ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã™ã‚‹ä½•ã‚‰ã‹ã®**éš ã‚ŒãŸå‹•ä½œ**ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã€‚

---

## æ ¹æœ¬åŽŸå› ã®ç‰¹å®š

### PyBoyå®Ÿè£…ã¨ã®å·®åˆ†

**å‚è€ƒ**: `02-interrupts.gb_timer_compatibility_plan.md`

PyBoyåˆ†æžã«ã‚ˆã‚Šã€æ‰‹å…ƒå®Ÿè£…ã¨ã®æœ€å¤§ã®é•ã„ã¯**çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã®æ¬ å¦‚**:

#### ç¾åœ¨ã®å•é¡Œç‚¹

```python
# ç¾åœ¨ã®å®Ÿè£…ï¼ˆâŒ ç‹¬ç«‹ã‚«ã‚¦ãƒ³ã‚¿æ–¹å¼ï¼‰
self.DIV_counter = 0      # DIVå°‚ç”¨ã‚«ã‚¦ãƒ³ã‚¿
self.TIMA_counter = 0     # TIMAå°‚ç”¨ã‚«ã‚¦ãƒ³ã‚¿
self.dividers = [10, 4, 6, 8]  # æ•°å­¦çš„ã«ã¯æ­£ã—ã„
```

- DIVã¨TIMAãŒç‹¬ç«‹ã—ã¦å‹•ä½œ
- TACå¤‰æ›´æ™‚ã®éš ã‚ŒãŸå‹•ä½œãªã—
- DIVæ›¸ãè¾¼ã¿æ™‚ã®å‰¯ä½œç”¨ãªã—

#### Game Boyå®Ÿæ©Ÿã®å†…éƒ¨æ§‹é€ 

```
16384Hz Master Counter (system_counter >> 8)
    â†“
 â”Œâ”€ DIV (bit 8-15)
 â””â”€ Timer Multiplexer
     â”œâ”€ TAC=00: bit 10 (1024 cycles)
     â”œâ”€ TAC=01: bit 4  (16 cycles)  â† TAC=0x05ã§ä½¿ç”¨
     â”œâ”€ TAC=10: bit 6  (64 cycles)
     â””â”€ TAC=11: bit 8  (256 cycles)
```

**é‡è¦**: DIVã¨TIMAã¯åŒã˜çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆsystem_counterï¼‰ã‹ã‚‰æ´¾ç”Ÿã™ã‚‹ã€‚

### éš ã‚ŒãŸå‹•ä½œï¼ˆObscure Behaviorsï¼‰

#### 1. TACå¤‰æ›´æ™‚ã®ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡º

```python
# TACå¤‰æ›´æ™‚ã«ã‚¿ã‚¤ãƒžãƒ¼ãƒ“ãƒƒãƒˆãŒ1â†’0ã«å¤‰åŒ–ã™ã‚‹ã¨ã€TIMAãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹
old_timer_bit = get_timer_bit(old_tac)
new_timer_bit = get_timer_bit(new_tac)

if old_timer_bit and not new_timer_bit:
    increment_tima()  # éš ã‚ŒãŸã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼
```

#### 2. DIVæ›¸ãè¾¼ã¿æ™‚ã®ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡º

```python
# DIVæ›¸ãè¾¼ã¿ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰æ™‚ã«ã‚‚ã‚¿ã‚¤ãƒžãƒ¼ãƒ“ãƒƒãƒˆãŒ1â†’0ã«å¤‰åŒ–ã™ã‚‹å¯èƒ½æ€§
old_timer_bit = get_timer_bit(tac)
system_counter = 0  # DIVãƒªã‚»ãƒƒãƒˆ
new_timer_bit = get_timer_bit(tac)  # å¿…ãš0ã«ãªã‚‹

if old_timer_bit and not new_timer_bit:
    increment_tima()  # éš ã‚ŒãŸã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼
```

ã“ã‚Œã‚‰ã®ã€Œã‚°ãƒªãƒƒãƒã€å‹•ä½œã«ã‚ˆã‚Šã€Blarggãƒ†ã‚¹ãƒˆãŒæœŸå¾…ã™ã‚‹1500ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚

---

## çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…è¨ˆç”»

### Phase 1: çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…

#### 1.1 ãƒžã‚¹ã‚¿ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿å°Žå…¥

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/gameboy/timer.py`

```python
class Timer:
    def __init__(self, memory, debug=False):
        self.memory = memory
        self.debug = debug
        self.system_counter = 0  # å”¯ä¸€ã®ãƒžã‚¹ã‚¿ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿

    def get_div(self):
        """DIVãƒ¬ã‚¸ã‚¹ã‚¿å€¤ã‚’çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‹ã‚‰è¨ˆç®—"""
        return (self.system_counter >> 8) & 0xFF

    def get_timer_bit(self, tac):
        """TIMAã®æ›´æ–°ãƒ“ãƒƒãƒˆã‚’çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‹ã‚‰å–å¾—"""
        freq_select = tac & 0x03
        bit_positions = [10, 4, 6, 8]  # å®Ÿæ©Ÿæº–æ‹ 
        return (self.system_counter >> bit_positions[freq_select]) & 1
```

**é‡è¦**:
- `system_counter`ã¯æ¯Žã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- DIVã¯`system_counter >> 8`ã§è‡ªå‹•çš„ã«å¾—ã‚‰ã‚Œã‚‹ï¼ˆ256ã‚µã‚¤ã‚¯ãƒ«ã§1å¢—åŠ ï¼‰
- ã‚¿ã‚¤ãƒžãƒ¼ãƒ“ãƒƒãƒˆã‚‚`system_counter`ã®ç‰¹å®šãƒ“ãƒƒãƒˆã‹ã‚‰å–å¾—

#### 1.2 tick()ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œå…¨æ›¸ãç›´ã—

```python
def tick(self, _cycles):
    cycles = _cycles - self.last_cycles
    if cycles == 0:
        return False
    self.last_cycles = _cycles

    # å„ã‚µã‚¤ã‚¯ãƒ«ã”ã¨ã«å‡¦ç†ï¼ˆç²¾å¯†åˆ¶å¾¡ï¼‰
    for _ in range(cycles):
        old_timer_bit = self.get_timer_bit(self.memory.io[0x07])  # TAC

        # ã‚·ã‚¹ãƒ†ãƒ ã‚«ã‚¦ãƒ³ã‚¿ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        self.system_counter = (self.system_counter + 1) & 0xFFFFFFFF

        # DIVã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹
        self.memory.io[0x04] = self.get_div()

        # ã‚¿ã‚¤ãƒžãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿
        if self.memory.io[0x07] & 0x04:  # TAC bit 2
            new_timer_bit = self.get_timer_bit(self.memory.io[0x07])

            # ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡ºï¼ˆ1â†’0ï¼‰
            if old_timer_bit and not new_timer_bit:
                self.increment_tima()

    return False  # ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã¯åˆ¥é€”å‡¦ç†
```

**åˆ©ç‚¹**:
- ã‚µã‚¤ã‚¯ãƒ«ç²¾åº¦ã®å®Œå…¨åˆ¶å¾¡
- ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸ã‚’è‡ªç„¶ã«æ¤œå‡º
- DIVã¨TIMAã®å®Œå…¨åŒæœŸ

### Phase 2: éš ã‚ŒãŸå‹•ä½œå®Ÿè£…

#### 2.1 DIVæ›¸ãè¾¼ã¿æ™‚ã®å½±éŸ¿

```python
def write_register(self, address, value):
    if address == 0xFF04:  # DIV
        old_timer_bit = self.get_timer_bit(self.memory.io[0x07])
        self.system_counter = 0  # ãƒžã‚¹ã‚¿ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆ
        new_timer_bit = self.get_timer_bit(self.memory.io[0x07])

        # ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸ã§TIMAæ›´æ–°
        if old_timer_bit and not new_timer_bit:
            self.increment_tima()
```

#### 2.2 TACå¤‰æ›´æ™‚ã®å‹•ä½œ

```python
elif address == 0xFF07:  # TAC
    old_tac = self.memory.io[0x07]
    old_timer_bit = self.get_timer_bit(old_tac)

    self.memory.io[0x07] = value
    new_timer_bit = self.get_timer_bit(value)

    # Game Boyå®Ÿæ©Ÿã®ã€Œã‚°ãƒªãƒƒãƒã€å‹•ä½œå†ç¾
    if old_timer_bit and not new_timer_bit:
        self.increment_tima()
```

### Phase 3: ç²¾å¯†ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡

#### 3.1 4ã‚µã‚¤ã‚¯ãƒ«é…å»¶å®Ÿè£…

```python
def increment_tima(self):
    current_tima = self.memory.io[0x05]
    if current_tima == 0xFF:
        # ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼: 4ã‚µã‚¤ã‚¯ãƒ«é…å»¶ã§TMAãƒªãƒ­ãƒ¼ãƒ‰
        self.tima_overflow_delay = 4
        self.memory.io[0x05] = 0x00  # ä¸€æ™‚çš„ã«0x00
    else:
        self.memory.io[0x05] = (current_tima + 1) & 0xFF
```

#### 3.2 å‰²ã‚Šè¾¼ã¿ç™ºç”Ÿã®æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°

```python
def tick(self, _cycles):
    # ... (ä¸Šè¨˜ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†)

    # TIMAã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼é…å»¶å‡¦ç†
    if hasattr(self, 'tima_overflow_delay') and self.tima_overflow_delay > 0:
        self.tima_overflow_delay -= cycles
        if self.tima_overflow_delay <= 0:
            # TMAãƒªãƒ­ãƒ¼ãƒ‰ã¨å‰²ã‚Šè¾¼ã¿ç™ºç”Ÿ
            self.memory.io[0x05] = self.memory.io[0x06]  # TMA
            if_reg = self.memory.read_byte(0xFF0F)
            self.memory.write_byte(0xFF0F, if_reg | 0x04)
            return True

    return False
```

### Phase 4: Blarggãƒ†ã‚¹ãƒˆç‰¹åŒ–èª¿æ•´

#### 4.1 åˆæœŸå€¤ã®æ­£ç¢ºãªè¨­å®š

- Boot ROMå®Œäº†æ™‚ã®æ­£ç¢ºãªsystem_counterå€¤
- Blarggãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®é©åˆ‡ãªåˆæœŸåŒ–

#### 4.2 1500ã‚µã‚¤ã‚¯ãƒ«æ™‚ç‚¹ã§ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å®Ÿç¾

- çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã«ã‚ˆã‚‹æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡
- DIVã¨TIMAã®å®Œå…¨åŒæœŸ

---

## æŠ€è¡“çš„è©³ç´°

### Timer Frequencyè¨ˆç®—

```
TAC bits 0-1: Timer Frequency Select
00: 4096 Hz   = CPU_FREQ / 1024 = 4194304 / 1024
01: 262144 Hz = CPU_FREQ / 16   = 4194304 / 16
10: 65536 Hz  = CPU_FREQ / 64   = 4194304 / 64
11: 16384 Hz  = CPU_FREQ / 256  = 4194304 / 256

Divider values (system_counter bit positions):
TAC=00: bit 10 (1 << 10 = 1024 cycles)
TAC=01: bit 4  (1 << 4  = 16 cycles)
TAC=10: bit 6  (1 << 6  = 64 cycles)
TAC=11: bit 8  (1 << 8  = 256 cycles)
```

### ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡ºã®é‡è¦æ€§

```
ä¾‹: TAC=0x05ã‹ã‚‰0x06ã«å¤‰æ›´

TAC=0x05 (01 + enable): bit 4ã‚’ç›£è¦–
TAC=0x06 (10 + enable): bit 6ã‚’ç›£è¦–

system_counter = 0b1111111111111111 ã®å ´åˆ:
- bit 4 = 1
- bit 6 = 1

TACå¤‰æ›´ç›´å¾Œ:
- æ–°ã—ã„ã‚¿ã‚¤ãƒžãƒ¼ãƒ“ãƒƒãƒˆï¼ˆbit 6ï¼‰ã¯å¤‰ã‚ã‚‰ãš1
- ã—ã‹ã—ã€ç›£è¦–å¯¾è±¡ãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚ã€æ¬¡ã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã¾ã§ã®æ™‚é–“ãŒå¤‰ã‚ã‚‹

ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§:
- old bit = 1, new bit = 0 â†’ TIMAã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆã‚°ãƒªãƒƒãƒï¼‰
```

### PyBoy vs æ‰‹å…ƒå®Ÿè£…ã®æ¯”è¼ƒ

| é …ç›® | PyBoy | æ‰‹å…ƒå®Ÿè£…ï¼ˆç¾åœ¨ï¼‰ | æ‰‹å…ƒå®Ÿè£…ï¼ˆç›®æ¨™ï¼‰ |
|------|-------|------------------|------------------|
| ãƒžã‚¹ã‚¿ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ | âœ… ã‚ã‚Š | âŒ ãªã— | âœ… å®Ÿè£…äºˆå®š |
| DIV/TIMAåŒæœŸ | âœ… å®Œå…¨åŒæœŸ | âŒ ç‹¬ç«‹ | âœ… å®Ÿè£…äºˆå®š |
| TACå¤‰æ›´ã‚°ãƒªãƒƒãƒ | âœ… ã‚ã‚Š | âŒ ãªã— | âœ… å®Ÿè£…äºˆå®š |
| DIVæ›¸ãè¾¼ã¿ã‚°ãƒªãƒƒãƒ | âœ… ã‚ã‚Š | âŒ ãªã— | âœ… å®Ÿè£…äºˆå®š |
| 4ã‚µã‚¤ã‚¯ãƒ«é…å»¶ | âœ… ã‚ã‚Š | âš ï¸ éƒ¨åˆ†çš„ | âœ… å®Ÿè£…äºˆå®š |
| tick()å‘¼ã³å‡ºã— | è¤‡æ•°ç®‡æ‰€ | è¤‡æ•°ç®‡æ‰€ | åŒã˜ |

---

## å‚è€ƒè³‡æ–™

### æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

1. **02-interrupts.gb_timer_compatibility_plan.md**
   - çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ãªå®Ÿè£…è¨ˆç”»
   - Phase 1-4ã®å…·ä½“çš„ãªå®Ÿè£…æ‰‹é †

2. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°çµæžœèª¿æŸ»å†…å®¹.md**
   - Blarggãƒ†ã‚¹ãƒˆæœŸå¾…å€¤ã¨å®Ÿéš›ã®å‹•ä½œã®å·®åˆ†åˆ†æž
   - æ•°å­¦çš„è§£æžã¨TIMAåˆæœŸå€¤ã®é€†ç®—

3. **CLAUDE.md**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æŠ€è¡“ä»•æ§˜
   - æ—¢å­˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã®æ¦‚è¦

### å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹

1. **Pan Docs - Timer and Divider Registers**
   - https://gbdev.io/pandocs/Timer_and_Divider_Registers.html
   - Game Boyå®Ÿæ©Ÿã®éš ã‚ŒãŸå‹•ä½œï¼ˆObscure Behaviorsï¼‰ã®èª¬æ˜Ž

2. **PyBoy ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰**
   - `external/PyBoy/pyboy/core/timer.py`
   - å®Ÿéš›ã«02-interrupts.gbã‚’é€šéŽã™ã‚‹å®Ÿè£…

3. **Blargg Test ROMs**
   - https://gbdev.gg8.se/files/roms/blargg-gb-tests/
   - cpu_instrs.gb ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- [ ] `system_counter`å¤‰æ•°ã®è¿½åŠ 
- [ ] `get_div()`ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] `get_timer_bit()`ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] `tick()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œå…¨æ›¸ãç›´ã—
- [ ] ã‚µã‚¤ã‚¯ãƒ«å˜ä½ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†
- [ ] ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡ºã®å®Ÿè£…

### Phase 2: éš ã‚ŒãŸå‹•ä½œå®Ÿè£…
- [ ] DIVæ›¸ãè¾¼ã¿æ™‚ã®ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡º
- [ ] TACå¤‰æ›´æ™‚ã®ã‚°ãƒªãƒƒãƒå‹•ä½œ
- [ ] çµ±ä¸€ã‚«ã‚¦ãƒ³ã‚¿ã§ã®å®Œå…¨åŒæœŸ

### Phase 3: ç²¾å¯†ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
- [ ] 4ã‚µã‚¤ã‚¯ãƒ«é…å»¶å®Ÿè£…
- [ ] å‰²ã‚Šè¾¼ã¿ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°ç²¾å¯†åŒ–
- [ ] TMAèª­ã¿è¾¼ã¿åˆ¶å¾¡

### Phase 4: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ
- [ ] 02-interrupts.gbå®Œå…¨é€šéŽ
- [ ] ä»–ã®Blarggãƒ†ã‚¹ãƒˆé€€è¡Œé˜²æ­¢
- [ ] big2small.gbäº’æ›æ€§ç¢ºèª
- [ ] instr_timing.gbï¼ˆ96.5%ç¶­æŒï¼‰
- [ ] mem_timing.gbï¼ˆæˆåŠŸç¶­æŒï¼‰

---

## æŽ¨å®šå·¥æ•°

- **Phase 1**: 1-1.5æ™‚é–“ï¼ˆã‚³ã‚¢å®Ÿè£…ï¼‰
- **Phase 2**: 0.5-1æ™‚é–“ï¼ˆéš ã‚ŒãŸå‹•ä½œï¼‰
- **Phase 3**: 0.5æ™‚é–“ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ï¼‰
- **Phase 4**: 0.5-1æ™‚é–“ï¼ˆãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°ï¼‰

**åˆè¨ˆ**: 2.5-4æ™‚é–“

---

## æœŸå¾…ã•ã‚Œã‚‹æˆæžœ

- âœ… 02-interrupts.gb: âŒ FAIL â†’ âœ… PASS
- âœ… Blarggãƒ†ã‚¹ãƒˆ: 10/11 (90.9%) â†’ **11/11 (100%)** ðŸŽ‰
- âœ… Game Boyå®Ÿæ©Ÿãƒ¬ãƒ™ãƒ«ã®å®Œå…¨äº’æ›æ€§
- âœ… éš ã‚ŒãŸå‹•ä½œï¼ˆObscure Behaviorsï¼‰ã®å®Œå…¨å®Ÿè£…

---

---

# ðŸš¨ðŸš¨ðŸš¨ é‡è¦ï¼šæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š ðŸš¨ðŸš¨ðŸš¨

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ28æ—¥
**ç¾åœ¨ã®çŠ¶æ³**: Phase 1-3å®Ÿè£…å®Œäº†ã€PyBoyæ–¹å¼ã¸å›žå¸°å®Œäº†
**02-interrupts.gbçŠ¶æ…‹**: âŒ ä¾ç„¶ã¨ã—ã¦ Failed #4

---

## ðŸŽ¯ðŸŽ¯ðŸŽ¯ **ã‚ªãƒ—ã‚·ãƒ§ãƒ³D: PyBoyè©³ç´°è§£æžã‚’å®Ÿæ–½ã™ã‚‹** ðŸŽ¯ðŸŽ¯ðŸŽ¯

### âš¡ ã“ã®æ–¹é‡ã‚’å¼·ãå¼·ãé¸æŠžã™ã‚‹ âš¡

**ç†ç”±**:
1. PyBoyã¯**å®Ÿéš›ã«02-interrupts.gbã‚’é€šéŽã—ã¦ã„ã‚‹**
2. åŒã˜PyBoyæ–¹å¼ã®tick()ã‚’å®Ÿè£…ã—ãŸãŒã€ã¾ã é€šéŽã—ãªã„
3. **å¿…ãšè¦‹è½ã¨ã—ã¦ã„ã‚‹ä½•ã‹ãŒã‚ã‚‹**
4. ä»–ã®10ãƒ†ã‚¹ãƒˆã¯é€šéŽã—ã¦ã„ã‚‹ã®ã§ã€ã‚ãšã‹ãªå·®ç•°ã®ã¯ãš

### ðŸ“‹ è©³ç´°è§£æžã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ

#### ã‚¿ã‚¹ã‚¯1: PyBoyã®02-interrupts.gbå®Ÿè¡Œãƒ­ã‚°å–å¾—
- [ ] PyBoyã§02-interrupts.gbã‚’å®Ÿè¡Œ
- [ ] TAC=0x05è¨­å®šå‰å¾Œã®è©³ç´°ãƒ­ã‚°
- [ ] 1500ã‚µã‚¤ã‚¯ãƒ«æ™‚ç‚¹ã®TIMA/IFå€¤
- [ ] ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‰²ã‚Šè¾¼ã¿ãŒç™ºç”Ÿã™ã‚‹ã‹

#### ã‚¿ã‚¹ã‚¯2: PyBoy timer.pyã®å®Œå…¨è§£æž
- [ ] `external/PyBoy/pyboy/core/timer.py`ã®å…¨ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
- [ ] `tick()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œå…¨ç†è§£
- [ ] `write_register()`ã®å…¨ã¦ã®æ¡ä»¶åˆ†å²
- [ ] éš ã‚ŒãŸåˆæœŸåŒ–å‡¦ç†ãŒãªã„ã‹

#### ã‚¿ã‚¹ã‚¯3: PyBoy mb.pyï¼ˆãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ï¼‰ã®è§£æž
- [ ] `external/PyBoy/pyboy/core/mb.py`ã®timer.tick()å‘¼ã³å‡ºã—
- [ ] ã‚¿ã‚¤ãƒžãƒ¼å‰²ã‚Šè¾¼ã¿ã®è¨­å®šæ–¹æ³•
- [ ] ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®ç›¸äº’ä½œç”¨

#### ã‚¿ã‚¹ã‚¯4: æ‰‹å…ƒå®Ÿè£…ã¨PyBoyã®å®Œå…¨æ¯”è¼ƒ
- [ ] åˆæœŸåŒ–å‡¦ç†ã®å·®åˆ†
- [ ] tick()ãƒ¡ã‚½ãƒƒãƒ‰ã®è©³ç´°æ¯”è¼ƒï¼ˆè¡Œå˜ä½ï¼‰
- [ ] ãƒ¬ã‚¸ã‚¹ã‚¿èª­ã¿æ›¸ãã®å·®åˆ†
- [ ] å‰²ã‚Šè¾¼ã¿å‡¦ç†ã®å·®åˆ†

#### ã‚¿ã‚¹ã‚¯5: å·®åˆ†ã‚’å…ƒã«ä¿®æ­£å®Ÿè£…
- [ ] ç™ºè¦‹ã—ãŸå·®åˆ†ã‚’æ‰‹å…ƒå®Ÿè£…ã«é©ç”¨
- [ ] 02-interrupts.gbã§æ¤œè¨¼
- [ ] ä»–ã®10ãƒ†ã‚¹ãƒˆã§é€€è¡ŒãŒãªã„ã‹ç¢ºèª

### ðŸ” é‡ç‚¹èª¿æŸ»ãƒã‚¤ãƒ³ãƒˆ

1. **TIMA_counterã¨DIV_counterã®åˆæœŸå€¤**
   - PyBoyã§ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã‹ï¼Ÿ
   - post-bootæ™‚ã®å€¤ã¯ï¼Ÿ

2. **TACæ›¸ãè¾¼ã¿æ™‚ã®å‰¯ä½œç”¨**
   - PyBoyã§æœ¬å½“ã«ä½•ã‚‚ã—ã¦ã„ãªã„ã‹ï¼Ÿ
   - TIMA_counterã®ãƒªã‚»ãƒƒãƒˆç­‰ã¯ãªã„ã‹ï¼Ÿ

3. **å‰²ã‚Šè¾¼ã¿ãƒ•ãƒ©ã‚°ã®è¨­å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°**
   - tick()ãŒ`True`ã‚’è¿”ã™ã‚¿ã‚¤ãƒŸãƒ³ã‚°
   - mb.pyã§ã®`set_interruptflag()`å‘¼ã³å‡ºã—

4. **Blarggãƒ†ã‚¹ãƒˆç‰¹æœ‰ã®å‹•ä½œ**
   - ç‰¹å®šã®ROMåã§ã®ç‰¹æ®Šå‡¦ç†ã¯ãªã„ã‹ï¼Ÿ
   - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã‚ˆã†ãªéš ã—æ©Ÿèƒ½ã¯ãªã„ã‹ï¼Ÿ

### ðŸ’ª å®Ÿæ–½æ±ºæ„è¡¨æ˜Ž

**ã“ã®æ–¹é‡ã§çµ¶å¯¾ã«02-interrupts.gbã‚’é€šéŽã•ã›ã‚‹ï¼**

ç†ç”±:
- âœ… æ—¢ã«10/11é€šéŽã—ã¦ã„ã‚‹ï¼ˆ90.9%ï¼‰
- âœ… PyBoyã¨ã„ã†æˆåŠŸä¾‹ãŒå­˜åœ¨ã™ã‚‹
- âœ… ã‚¿ã‚¤ãƒžãƒ¼åŸºæœ¬å‹•ä½œã¯å®Œç’§
- âœ… ç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡ºã®æ¦‚å¿µã‚‚ç†è§£æ¸ˆã¿
- ðŸŽ¯ **ã‚ã¨ä¸€æ­©ã§100%é”æˆï¼**

### ðŸ“Š æŽ¨å®šå·¥æ•°

- **ã‚¿ã‚¹ã‚¯1-3**: 1-1.5æ™‚é–“ï¼ˆPyBoyè§£æžï¼‰
- **ã‚¿ã‚¹ã‚¯4**: 30åˆ†ï¼ˆæ¯”è¼ƒåˆ†æžï¼‰
- **ã‚¿ã‚¹ã‚¯5**: 30åˆ†-1æ™‚é–“ï¼ˆä¿®æ­£ã¨æ¤œè¨¼ï¼‰

**åˆè¨ˆ**: 2-3æ™‚é–“ã§**11/11 (100%)é”æˆã‚’ç›®æŒ‡ã™ï¼**

---

## ðŸ”¥ è¡Œå‹•é–‹å§‹å®£è¨€ ðŸ”¥

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ã‚¿ã‚¹ã‚¯1ã‹ã‚‰PyBoyè©³ç´°è§£æžã‚’é–‹å§‹ã™ã‚‹

**ç›®æ¨™**: 02-interrupts.gbã‚’é€šéŽã•ã›ã€Blarggãƒ†ã‚¹ãƒˆ100%é”æˆ

**æœŸé™**: æœ¬ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã®å®Œäº†ã‚’ç›®æŒ‡ã™

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ28æ—¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³Dé¸æŠžï¼‰
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: **PyBoyè©³ç´°è§£æžé–‹å§‹ï¼ˆã‚¿ã‚¹ã‚¯1ï¼‰**
