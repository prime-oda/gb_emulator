# Game Boy エミュレータ 互換性向上計画

**作成日**: 2025年11月23日
**最終更新**: 2025年11月23日
**現状**: Blargg CPU Instructions 11/11 (100%), 高速化 4.53倍達成

---

## 現状サマリー

### 達成済みマイルストーン

| カテゴリ | テスト | 結果 | 備考 |
|---------|--------|------|------|
| CPU命令 | cpu_instrs.gb | ✅ 11/11 (100%) | ROMパッチ適用時 |
| 命令タイミング | instr_timing.gb | ⚠️ 96.5% (494/512) | 残り18エラー |
| メモリタイミング | mem_timing.gb | ✅ 完全成功 | Phase 1-4完了 |
| 高速化 | Cython最適化 | ✅ 4.53倍 | Phase 0-2完了 |

---

## Phase 1: Blarggテスト完全対応（基礎）

Blargg氏のテストROMは新規エミュレータ開発時の最初の関門。基本的な挙動を検証する。

### 1.1 CPU命令動作テスト
- [x] **cpu_instrs.gb** - 全CPU命令の結果検証 ✅ 完了
  - 演算結果、フラグ、副作用を包括的にテスト
  - 11/11サブテスト通過（ROMパッチ適用）

### 1.2 CPU命令タイミングテスト
- [ ] **instr_timing.gb** - 実行サイクル数検証 ⚠️ 96.5%
  - 現状: 494/512命令正確
  - 残り18エラーの詳細分析と修正が必要
  - 条件付きジャンプの成立/不成立両ケース検証

### 1.3 メモリアクセスタイミングテスト
- [x] **mem_timing.gb** - メモリバスタイミング検証 ✅ 完了
  - 01-read_timing.gb: ✅
  - 02-write_timing.gb: ✅
  - 03-modify_timing.gb: ✅
  - MemoryAccessScheduler実装済み

### 1.4 割り込みタイミングテスト
- [ ] **interrupt_time.gb** - 割り込み発生タイミング検証
  - ISR実行までのタイミング
  - HALT復帰の挙動
  - HALTバグ（IME=0でHALT中の割り込み）

### 1.5 OAM腐敗バグテスト
- [ ] **oam_bug.gb** - DMG特有のOAM汚染バグ再現
  - DMA転送中の特定条件でスプライト属性破損
  - DMGのみで発生（CGB以降は修正済み）
  - DMGエミュレーション時に意図的にバグを再現する必要あり

### 1.6 サウンドハードウェアテスト
- [ ] **dmg_sound.gb / dmg_sound-2.gb** - DMG音源検証
  - 長さカウンタ、エンベロープ、周波数スイープ
  - ノイズLFSR
  - 注意: テスト#10は実機でもランダム要素あり

- [ ] **cgb_sound.gb** - CGB音源検証
  - CGBでは音量エンベロープタイミングが異なる

---

## Phase 2: Mooneye Test Suite対応（高精度）

Gekkio氏による最も信頼性の高いテストスイート。実機で全バリエーション検証済み。

### 2.1 Acceptanceテスト（基本機能）

#### ブートROM関連
- [ ] boot_regs_* - 各レジスタ初期値検証（モデル別）
- [ ] boot_div_* - DIVレジスタリセットタイミング
- [ ] boot_hwio_* - 未使用IOポート初期値

#### CPU命令・割り込み
- [ ] instr/daa - DAA命令検証
- [ ] ei_sequence - EI命令直後の割り込み有効化タイミング
- [ ] if_ie_registers - 割り込みフラグ/イネーブル処理
- [ ] halt_ime0_* - HALTバグ関連テスト
- [ ] halt_ime1_* - HALT+IME組み合わせ

#### タイマ/DIV
- [ ] tima_reload - TIMAが0xFF→0x00に戻るサイクル
- [ ] tima_write_reloading - オーバーフロー中書き換え挙動
- [ ] div_* - DIVレジスタとTIMAの関係

#### OAM DMA
- [ ] oam_dma_start - DMA開始直後の挙動
- [ ] oam_dma_timing - DMA実行中のCPU停止時間
- [ ] oam_dma_restart - DMA中の新DMA開始
- [ ] dma_sources_* - DMA元アドレス禁止領域

#### PPUタイミング
- [ ] hblank_ly_scx_timing - Hブランク/LY/スクロールタイミング
- [ ] intr_2_mode*_timing - STATモード割り込み発生サイクル
- [ ] lcdon_timing - LCD ON直後のモード遷移
- [ ] stat_lyc_* - LYC比較によるSTAT割り込み

#### シリアルポート
- [ ] boot_sclk_align - SC初期状態検証

### 2.2 Emulator-onlyテスト
- [ ] MBC1/2/5大容量ROM検証
- [ ] 複数カートリッジ切替挙動

### 2.3 Manual-onlyテスト
- [ ] sprite_priority - オブジェクト優先度（目視確認）

---

## Phase 3: Acidテスト対応（PPU精度）

Matt Currie氏による画面描画精度の一目判定テスト。

### 3.1 基本Acidテスト
- [ ] **dmg-acid2.gb** - DMG PPU描画精度
  - 正確なら特定の顔文字画像が正しく表示
  - ウィンドウON/OFF、WXレジスタ操作
  - 1行10スプライト上限、BG/OBJ優先度
  - ライン単位描画でもパス可能

- [ ] **cgb-acid2.gbc** - CGB PPU描画精度
  - カラー再現
  - CGB特有のOBJ優先度ルール

### 3.2 超高難度テスト
- [ ] **cgb-acid-hell.gbc** - 「パスできません」テスト
  - モード3期間中のレジスタ書き換え
  - 走査線途中での操作
  - パスできるエミュレータはごく僅か

### 3.3 Mealybug Tearoom Tests
- [ ] モード3期間中の各種レジスタ操作テスト
  - BGマップ変更
  - ウィンドウ有効ビット変更
  - OBJサイズ変更
  - DMG/CGB(リビジョン別)で結果が異なる

---

## Phase 4: 追加テスト対応（発展）

### 4.1 MBC/RTC関連
- [ ] **MBC3 Tester** - MBC3バッテリーバックアップ/RTC検証
  - RAMバンク切替
  - RTC読み書きタイミング
  - 秒/分/時/日カウンタ

- [ ] **rtc3test** - RTC詳細テスト

### 4.2 高精度エミュレータ由来テスト
- [ ] **Gambatte テストスイート** - 非公開だがコミュニティ収集
  - ブートROM模倣
  - RTC検証

- [ ] **SameSuite** - SameBoy作者のテスト
  - CGB倍速モード
  - CGB音源
  - SGB機能

### 4.3 Hacktix氏のテスト
- [ ] **Bully** - PPU微細挙動
- [ ] **Scribbltests** - LCD走査タイミング/スクロール
- [ ] **Strikethrough** - スプライト優先度/描画タイミング

### 4.4 その他
- [ ] **AGE Test ROMs** - c-sp氏
- [ ] **little-things-gb** - Damian Yerrick氏
- [ ] **TurtleTests** - Brian Jia氏
- [ ] **gbmicrotest** - aappleby氏

---

## 優先度と工数見積もり

### 最優先（短期: 1-2週間）
| タスク | 優先度 | 工数 | 効果 |
|--------|--------|------|------|
| instr_timing.gb 100%達成 | ⭐⭐⭐ | 1-2日 | 基礎完成 |
| interrupt_time.gb検証 | ⭐⭐⭐ | 1日 | 割り込み精度 |
| dmg-acid2.gb対応 | ⭐⭐⭐ | 2-3日 | PPU精度可視化 |

### 高優先（中期: 1ヶ月）
| タスク | 優先度 | 工数 | 効果 |
|--------|--------|------|------|
| Mooneye Acceptance主要テスト | ⭐⭐ | 1-2週間 | 高精度基盤 |
| oam_bug.gb対応 | ⭐⭐ | 2-3日 | DMG互換性 |
| dmg_sound.gb対応 | ⭐⭐ | 3-5日 | APU精度 |

### 中優先（長期: 2-3ヶ月）
| タスク | 優先度 | 工数 | 効果 |
|--------|--------|------|------|
| cgb-acid2.gbc対応 | ⭐ | 1週間 | CGB対応 |
| Mealybug Tests対応 | ⭐ | 1-2週間 | PPU超精密 |
| MBC3/RTC対応 | ⭐ | 1週間 | セーブ機能 |

### 低優先（将来）
| タスク | 優先度 | 工数 | 効果 |
|--------|--------|------|------|
| cgb-acid-hell.gbc | - | 未定 | 究極精度 |
| SameSuite完全対応 | - | 未定 | 最高互換性 |

---

## エミュレータ精度比較（参考）

Daid氏による比較データ（263項目中）:

| エミュレータ | 通過数 | 通過率 |
|-------------|--------|--------|
| SameBoy | 257 | 97.7% |
| Beaten Dying Moon | 249 | 94.7% |
| Emulicious | 245 | 93.2% |
| BGB | 204 | 77.6% |
| Gambatte | 171 | 65.0% |
| mGBA | 150 | 57.0% |

**目標**: SameBoy/BDMレベルの精度を目指す

---

## テストROM実行上の注意点

### 出力確認方法
- リンクポート経由またはレジスタ操作で結果伝達
- シリアル出力フック、LD B,B命令検出が必要
- 画面表示しないROMも多い

### ブートROM
- boot_*テストは公式ブートROM挙動が前提
- 省略時は初期値を手動設定する必要あり

### ハード差異
- DMG系/CGB系で挙動が異なるテストあり
- テスト名の「-C」「-GS」等で対象ハードを識別

### 実機依存挙動
- 一部テストは実機でも結果がぶれる
- 複数回試行や他テストとの総合判断が重要

---

## 参考資料

### テストROMダウンロード
- [c-sp/game-boy-test-roms](https://github.com/c-sp/game-boy-test-roms) - 全テストROM集約
- [Blargg's Test ROMs](https://gbdev.gg8.se/files/roms/blargg-gb-tests/)
- [Mooneye GB](https://github.com/Gekkio/mooneye-gb)
- [dmg-acid2](https://github.com/mattcurrie/dmg-acid2)

### 技術資料
- [Pan Docs](https://gbdev.io/pandocs/) - Game Boy技術仕様
- [Daid's GB Emulator Shootout](https://daid.github.io/GBEmulatorShootout/) - 精度比較

---

**次のアクション**: Phase 1の残りタスク（instr_timing.gb 100%達成）から開始
